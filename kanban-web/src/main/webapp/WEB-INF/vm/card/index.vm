<style >
    select{
        width: 150px;
    }
</style>
<div>
    -&gt;<a href="/space/showSpace.htm?spaceId=$spaceId"><b>$spaceName</b></a>
</div>

<div class="tab-pane" id="card" style="width: 128%;">
    <form class="form-search" name="searchForm" id="searchForm">
    </form>

    <div>
        空间模板列表：
        <select id="chooseTemplate">
            <option value="-1" selected="selected">全选</option>
            #foreach($template in $templateList)
                <option value="${template.id}" >${template.name}</option>
            #end
        </select>

        卡片类型：
        <select id="chooseCardType">
            <option value="-1" selected="selected">全选</option>
            <option value="1">Story</option>
            <option value="2">Task</option>
            <option value="3">Bug</option>
        </select>

        迭代：
        <select id="chooseSprint">
            <option value="-1" selected="selected">全选</option>
        </select>

        过滤：
        <select id="cardTableFilter" multiple="multiple">
            <option value="title" selected="selected">标题</option>
            <option value="status" selected="selected">状态</option>
            <option value="cardType" selected="selected">类型</option>
            <option value="sprint" selected="selected">迭代</option>
            <option value="createTime" selected="selected">创建时间</option>
        </select>

        <a href="javascript:showLane()" class="btn btn-danger">卡片墙</a>
        <a href="javascript:void(0)" target="_blank" id="exportExcel" class="btn btn-success">下载</a>
        <a href="javascript:click(function())" class="btn btn-primary" id="createCardBtn">新建卡片</a>
    </div>

    <div id="chooseAttr" align="left">

    </div>
    <input type="hidden" id="spaceId" value="$spaceId" />
    <input type="hidden" id="templateList" value="$templateList">
    <input type="hidden" id="cardTypeId" value="-1">
    <input type="hidden" id="cardTypeShow" value="$!cardTypeShow">
    <input type="hidden" id="templateIdShow" value="$!templateIdShow">
    <input type="hidden" id="sprintShow" value="$!sprintShow">
    <input type="hidden" id="maxSprintShow" value="$!maxSprintShow">

    <table class="table table-bordered">
        <thead>
        <tr id="cardHeader">
            <th><a name="编号|sortTable(0, '编号', 'number', true, event)" herf="#" onclick="sortTable(0, '编号', 'number', true, event)">编号</a></th>
            <th name="title"><a name="标题|sortTable(1, '标题', 'text', true, event)" herf="#" onclick="sortTable(0, '标题', 'text', true, event)">标题</a></th>
            <th name="status"><a name="状态|sortTable(2, '状态', 'text', true, event)" herf="#" onclick="sortTable(0, '状态', 'text', true, event)">状态</a></th>
            <th name="cardType"><a name="类型|sortTable(3, '类型', 'text', true, event)" herf="#" onclick="sortTable(0, '类型', 'text', true, event)">类型</a></th>
            <th name="sprint"><a name="迭代|sortTable(4, '迭代', 'number', true, event)" herf="#" onclick="sortTable(4, '迭代', 'number', true, event)">迭代</a></th>
            <th name="createTime"><a name="创建时间|sortTable(7, '创建时间', 'text', true, event)" herf="#" onclick="sortTable(0, '创建时间', 'text', true, event)">创建时间</a></th>
            <th>操作</th>
        </tr>
        </thead>

        <tbody id="cardTable">

        </tbody>
    </table>
    <br/>
    <br/>
    <br/>
    <div>
        <input type="hidden" id="pageNo">
        <input type="hidden" id="maxPage">
        <ul class="pager">
            <li id="previous_li" class="previous"><a onclick="previous()">&larr; 上一页</a></li>
            <li id="pageSize" class="dropdown">
                页面大小：
                <select id="choosePageSize" style="width: 65px;">
                    <option value="30" selected="selected">30</option>
                    <option value="50">50</option>
                    <option value="200">200</option>
                </select>
            </li>
            <li id="next_li" class="next"><a onclick="next()">下一页 &rarr;</a></li>
        </ul>
    </div>

</div>
<div id="createCard" class="modal hide fade">
    <div class="modal-dialog modal-sm" >
        <div class="modal-header">
            <button type="button" class="dialog-close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h5>新建卡片</h5>
        </div>
        <div class="modal-body">
            <form id="createCardForm" action="/card/createCard.htm" method="post">
                <table>

                    <tr>
                        <td>当前空间：&nbsp;&nbsp;&nbsp;</td>
                        <td>$!{spaceName}</td>
                        <input type="hidden" name="spaceId" value="$spaceId" />
                    </tr>
                    <tr>
                        <td>标题：&nbsp;&nbsp;&nbsp;</td>
                        <td><input type="text" id="title" name="title"></td>
                    </tr>
                    <tr>
                        <td>选择模板：&nbsp;&nbsp;&nbsp;</td>
                        <td>
                            <select id="selectTemplate" name="selectTemplate">
                                #foreach($item in $templateList)
                                    <option value="${item.id}" id="template-${item.id}">$!{item.name}</option>
                                #end
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <a onclick="hideCreateCard()">取消</a>
                        </td>
                        <td>
                            <a onclick="createCard()" class="btn btn-small btn-primary">创建</a>
                        </td>

                    </tr>
                </table>
            </form>

        </div>
    </div>
</div>

<div id="viewCard" class="modal hide fade">
    <div class="modal-dialog modal-sm" >
        <div class="modal-header">
            <button type="button" class="dialog-close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h5>卡片详情</h5>
        </div>
        <div class="modal-body">
            <form class="form-horizontal" id="view_form">

            </form>

        </div>

    </div>
</div>


<script type="text/javascript">

    var curWwwPath=window.document.location.href;
    var pathName=window.document.location.pathname;
    var pos=curWwwPath.indexOf(pathName);
    var localhostPaht=curWwwPath.substring(0,pos);

    var cardAttrList = null;
    var cardAttrLength = 0;

    var tempParentAttrList;
    var tempParentAttrLength = 0;
    var tempAttrList;
    var tempAllAttrList;
    var tempAttrLength = 0;
    var tempAllAttrLength = 0;
    var optionName;
    var optionArray = ["","",""];
    var optionValue1;
    var optionValue2;
    var optionAttrName = "";
    var optionAttrId = ["","",""];
    var cardList;
    var refreshUrl = "";
    var changeRemark = false;

    var sortColIdx = -1;
    var sortName = "";
    var sortType = "";
    var sortSeq = true;
    var sortEvent = "";

    var sums = ["总计","","","","","","",""];

    var fixedAttr = "title,status,sprint,createTime";
    var deselectedFixedFilter = "";
    var deselectedCustomizedFilter = "";

    var doFilter = false;

    var maxSprintId = 0;
    var savedSprintId = -1;
    var sprintListLoaded = false;

    function previous(){
        var pageNo = $("#pageNo").val();
        if (pageNo > 1){
            var url = localhostPaht+'/card/index.htm';
            var previous = pageNo-1;
            var templateId = $('#chooseTemplate option:selected').val();
            var sprintId = $('#chooseSprint option:selected').val();
            var cardType = $('#chooseCardType option:selected').val();
            var pageSize = $('#choosePageSize option:selected').val();
            var formData = "spaceId="+$("#spaceId").val()+"&templateId="+templateId+"&sprint="+sprintId
                    +"&cardTypeId="+$("#cardTypeId").val()+"&cardType="+cardType+"&pageNo="+previous+"&pageSize="+pageSize;
            doFilter = true;
            request(url, formData);
        }else{
            alert("当前已是第一页");
        }
    }

    function next(){
        var pageNo = $("#pageNo").val();
        var maxPage = $("#maxPage").val();
        if (pageNo < maxPage){
            var url = localhostPaht+'/card/index.htm';
            var next = Number(pageNo)+Number(1);
            var templateId = $('#chooseTemplate option:selected').val();
            var sprintId = $('#chooseSprint option:selected').val();
            var cardType = $('#chooseCardType option:selected').val();
            var pageSize = $('#choosePageSize option:selected').val();
            var formData = "spaceId="+$("#spaceId").val()+"&templateId="+templateId+"&sprint="+sprintId
                    +"&cardTypeId="+$("#cardTypeId").val()+"&cardType="+cardType+"&pageNo="+next+"&pageSize="+pageSize;
            doFilter = true;
            request(url, formData);
        }else{
            alert("当前已是最后一页");
        }
    }

    function createCard(){
        if (undefined ==$("#title").val() || $("#title").val() == ""){
            alert("卡片标题不能为空");
            return;
        }
        $("#createCardForm").submit();
        $("#title").val("");
    }

    function hideCreateCard(){
        $("#createCard").modal('hide');
    }

    $("#createCardBtn").click(function(){
        $("#createCard").modal({backdrop: 'static', keyboard: false});
    });

    function viewCard(cardId){
        var url = localhostPaht+'/card/queryCard.htm';
        var formData = "cardId="+cardId;
        $.ajax({
            url: url,
            data: formData,
            type: 'GET'
        }).done(function (data) {
            var card = eval("(" + data + ")");

            $('#view_form').children().remove();
            //$('#view_table').children().remove();

            var title = document.createElement("h4");
            title.setAttribute("class","green");
            title.innerHTML = card.cardTitle;
            document.getElementById("view_form").appendChild(title);

            var cardAttrList = card.cardAttrList;

            if (cardAttrList.length == 0){
                var notice = document.createElement("h4");
                notice.setAttribute("class","red");
                /*notice.setAttribute("style","color:red");*/
                notice.innerHTML = "卡片自定义属性尚未初始化，请对其进行编辑";
                document.getElementById("view_form").appendChild(notice);
            }

            for (var i=0;i<cardAttrList.length;i++){
                var div = document.createElement("div");
                div.setAttribute("class","control-group");
                var label = document.createElement("label");
                label.setAttribute("class","control-label");
                var div1 = document.createElement("div");
                div1.setAttribute("class","controls");
                div1.id = "value"+i;
                label.innerHTML = cardAttrList[i].attrName+":";
                div.appendChild(label);



                if ("checkBox" == cardAttrList[i].attrType){
                    var checkList = cardAttrList[i].attrValue.split(",");
                    for (var j=0;j<checkList.length;j++){
                        var checkBox = document.createElement("input");
                        checkBox.setAttribute("onclick","return false;");
                        checkBox.setAttribute("type","checkbox");

                        checkBox.checked = true;
                        div1.appendChild(checkBox);
                        var text = document.createTextNode(checkList[j]);

                        div1.appendChild(text);

                    }
                }else if ("richText" == cardAttrList[i].attrType){
                    var script = document.createElement("script");
                    script.setAttribute("id","editor");
                    script.setAttribute("type","text/plain");
                    script.setAttribute("style","width:800px");
                    script.innerHTML = cardAttrList[i].attrValue;
                    div1.appendChild(script);
                }else{
                    var input = document.createElement("input");
                    input.setAttribute("type","text");
                    input.value = cardAttrList[i].attrValue;
                    input.setAttribute("onfocus","this.blur()");
                    div1.appendChild(input);
                }

                div.appendChild(div1)
                $("#view_form").append(div);
            }

            $("#viewCard").modal({backdrop: 'static', keyboard: false});
        }).error(function () {
            alert("请求失败，请刷新页面！");
        });
        //搞不定的话，就新页面吧
        var editor_a = new baidu.editor.ui.Editor();
        editor_a.render( 'editor' ); //此处的参数值为编辑器的id值
    }

    function deleCard(cardId){
        var choice=confirm("确认要删除吗？", function() { }, null);
        if (!choice){
            return;
        }

        var url = localhostPaht+'/card/deleteCard.htm';
        var formData = "cardId="+cardId;
        $.ajax({
            url: url,
            data: formData,
            type: 'POST'
        }).done(function (data) {
            if ("SUCCESS" == data){
                filteredRequest();
            }
        }).error(function () {
            alert("请求失败，请刷新页面！");
        });
    }

    $(document).ready(function () {
        document.getElementById("LeftBox").style.display="none";

        $('#cardTableFilter').multiselect({
            allSelectedText: '全部显示',
            nonSelectedText: '选择',
            nSelectedText: ' 个已选择',
            onChange: function(element, checked) {
                if(checked === true) {
                    if (isFixedAttr(element.val())) {
                        deselectedFixedFilter = deselectedFixedFilter.replace("|" + element.val() + "|", "");
                    } else {
                        deselectedCustomizedFilter = deselectedCustomizedFilter.replace("|" + element.val() + "|", "");
                    }

                    var headers = document.getElementById("cardHeader").getElementsByTagName("th");
                    var i;
                    for(i = 0; i < headers.length; i++) {
                        if(headers[i].getAttribute("name") == element.val()) {
                            headers[i].style.display = "table-cell";
                            break;
                        }
                    }

                    var rows = document.getElementById("cardTable").getElementsByTagName("tr");
                    for(i = 0; i < rows.length; i++) {
                        var cols = rows[i].getElementsByTagName("td");

                        var j;
                        for(j = 0; j < cols.length; j++) {
                            if(cols[j].getAttribute("name") == element.val()) {
                                cols[j].style.display = "table-cell";
                                break;
                            }
                        }
                    }
                }
                else if(checked === false) {
                    if (isFixedAttr(element.val())) {
                        deselectedFixedFilter += "|" + element.val() + "|";
                    } else {
                        deselectedCustomizedFilter += "|" + element.val() + "|";
                    }

                    var headers = document.getElementById("cardHeader").getElementsByTagName("th");
                    var i;
                    for(i = 0; i < headers.length; i++) {
                        if(headers[i].getAttribute("name") == element.val()) {
                            headers[i].style.display = "none";
                            break;
                        }
                    }

                    var rows = document.getElementById("cardTable").getElementsByTagName("tr");
                    for(i = 0; i < rows.length; i++) {
                        var cols = rows[i].getElementsByTagName("td");

                        var j;
                        for(j = 0; j < cols.length; j++) {
                            if(cols[j].getAttribute("name") == element.val()) {
                                cols[j].style.display = "none";
                                break;
                            }
                        }
                    }
                }
            }
        });

        var pageSize = $.cookie('pageSize');
        if(pageSize != null) {
            var pageSizeSelections = document.getElementById("choosePageSize").getElementsByTagName("option");

            for(var i = 0; i < pageSizeSelections.length; i++) {
                if(pageSizeSelections[i].value == pageSize) {
                    pageSizeSelections[i].setAttribute("selected","selected");
                } else {
                    pageSizeSelections[i].removeAttribute("selected");
                }
            }
        }

        var selections = $("#chooseTemplate option");
        selections[1].setAttribute("selected", "selected");

        for(var i = 0; i < selections.length && i != 1; i++) {
            selections[i].removeAttribute("selected");
        }

        deselectedCustomizedFilter = "";
        doFilter = false;

        filteredRequest(true);
    });

    $("#chooseTemplate").change(function(){
        var templateId = $('#chooseTemplate option:selected').val();
        $.cookie('templateId', templateId, {expires: 30});

        changeRemark = true;
        filteredRequest(true);
    });

    $("#chooseSprint").change(function(){
        var sprintId = $('#chooseSprint option:selected').val();
        $.cookie('sprintId', sprintId, {expires: 30});

        changeRemark = true;
        filteredRequest(false);
    });

    $("#chooseCardType").change(function(){
        var cardType = $('#chooseCardType option:selected').val();
        $.cookie('cardType', cardType, {expires: 30});

        changeRemark = true;
        filteredRequest(false);
    });

    $("#choosePageSize").change(function(){
        var pageSize = $('#choosePageSize option:selected').val();
        $.cookie('pageSize', pageSize, {expires: 30});

        filteredRequest(false);
    });

    function getTemplateAttrList() {
        var templateId = $('#chooseTemplate option:selected').val();
        var url = localhostPaht+'/template/queryAttrList';
        var formData = "templateId="+templateId;//查找模板的ID，通过模板可以获得卡片属性？

        $.ajax({
            url: url,
            data: formData,
            type: 'POST',
            async: false
        }).done(function (data) {
            var template = eval("(" + data + ")");

            tempParentAttrList = template.parentAttrList;
            tempAttrList = template.attrList;
            tempAllAttrList = template.allAttrList;


            if(typeof(tempAllAttrList) != "undefined"){
                tempParentAttrList = "";
                tempAttrList = tempAllAttrList;
            }

            if (typeof(tempParentAttrList) != "undefined") {
                tempParentAttrLength = tempParentAttrList.length;

                for (var i = 0; i < tempParentAttrList.length; i++) {
                    if (tempParentAttrList[i].inputType == "richText") {
                        tempParentAttrLength--;
                    }
                }
            }

            if (typeof(tempAttrList) != "undefined") {
                tempAttrLength = tempAttrList.length;

                for (var i = 0; i < tempAttrList.length; i++) {
                    if (tempAttrList[i].inputType == "richText") {
                        tempAttrLength--;
                    }
                }
            }
        }).error(function () {
            alert("请求失败，请刷新页面！");
        });
    }

    function filteredRequest(clearFilter) {//根据下拉框刷新页面
        if($('#chooseTemplate option:selected').val() != "-1") {
            getTemplateAttrList();
        }

        var templateId = $('#chooseTemplate option:selected').val();
        var sprintId = $('#chooseSprint option:selected').val();
        var cardType = $('#chooseCardType option:selected').val();
        var pageSize = $('#choosePageSize option:selected').val();
        var url = localhostPaht+'/card/index.htm?spaceId='+$("#spaceId").val();
        refreshUrl = localhostPaht+'/space/cardList.htm?spaceId='+$("#spaceId").val();

        if(changeRemark == true)
        {
            url = url + '&templateId='+templateId+'&sprint='+sprintId+'&cardType='+cardType+'&pageSize='+pageSize;
            refreshUrl = refreshUrl+'&templateId='+templateId+'&sprint='+sprintId+'&cardType='+cardType+'&pageSize='+pageSize;
        }
        else
        {
            if($("#templateIdShow").val() == "")
            {
                url = url+'&templateId='+templateId;
                refreshUrl = refreshUrl+'&templateId='+templateId;
            }
            else
            {
                url = url+'&templateId='+$("#templateIdShow").val();
                refreshUrl = refreshUrl+'&templateId='+$("#templateIdShow").val();
            }

            if($("#cardTypeShow").val() == "")
            {
                url = url+'&cardType='+cardType;
                refreshUrl = refreshUrl+'&cardType='+cardType;
            }
            else
            {
                url = url+'&cardType='+$("#cardTypeShow").val();
                refreshUrl = refreshUrl+'&cardType='+$("#cardTypeShow").val();
            }

            if($("#sprintShow").val() == "")
            {
                url = url+'&sprint='+sprintId;
                refreshUrl = refreshUrl+'&sprint='+sprintId;
            }
            else
            {
                url = url+'&sprint='+$("#sprintShow").val();
                refreshUrl = refreshUrl+'&sprint='+$("#sprintShow").val();
            }

            url = url + '&pageSize='+pageSize;
            refreshUrl = refreshUrl + '&pageSize='+pageSize;
        }

        if (clearFilter) {
            deselectedCustomizedFilter = "";
            doFilter = false;
        } else {
            doFilter = true;
        }

        requestNew(url);
    }

    function requestNew(url){//更新列表
        $.ajax({
            url: url,
            type: 'POST'
        }).done(function (data) {
            var cardPage = eval("(" + data + ")");
            cardList = cardPage.data;
            var tempMax = 0;
            if($("#maxSprintShow").val() != "")
            {
                tempMax = parseInt($("#maxSprintShow").val());
            }

            for (var i=0;i<cardList.length;i++){
                var sprintId = parseInt(cardList[i].sprint);
                if (sprintId > maxSprintId) {
                    maxSprintId = sprintId;
                }
            }
            if(tempMax > maxSprintId)
            {
                maxSprintId = tempMax;
            }

            refreshUrl = refreshUrl+'&maxSprintId='+maxSprintId;

            if (!sprintListLoaded) {
                for (var i = 0; i <= maxSprintId; i++) {
                    var sprintList = document.getElementById("chooseSprint");

                    var sprintOption = document.createElement("option");
                    sprintOption.value = i;
                    sprintOption.text = i;
                    sprintList.appendChild(sprintOption);
                }

                sprintListLoaded = true;
            }

            var templateId = $('#chooseTemplate option:selected').val();
            var sprintId = $('#chooseSprint option:selected').val();
            var cardType = $('#chooseCardType option:selected').val();
            var cardTypeSelections = document.getElementById("chooseCardType").getElementsByTagName("option");
            var templateSelections = document.getElementById("chooseTemplate").getElementsByTagName("option");
            var sprintSelections = document.getElementById("chooseSprint").getElementsByTagName("option");

            if(changeRemark == true || $("#cardTypeShow").val() == "" || $("#templateIdShow").val() == "" || $("#sprintShow").val()== "")
            {
                for(var i = 0; i < cardTypeSelections.length; i++)
                {
                    if(cardType == cardTypeSelections[i].value)
                    {
                        cardTypeSelections[i].setAttribute("selected", "selected");
                    }
                    else
                    {
                        cardTypeSelections[i].removeAttribute("selected");
                    }
                }

                for(var i = 0;i < templateSelections.length; i++)
                {
                    if(templateId == templateSelections[i].value)
                    {
                        templateSelections[i].setAttribute("selected", "selected");
                    }
                    else
                    {
                        templateSelections[i].removeAttribute("selected");
                    }
                }

                for(var i = 0;i < sprintSelections.length; i++)
                {
                    if(sprintId == sprintSelections[i].value)
                    {
                        sprintSelections[i].setAttribute("selected", "selected");
                    }
                    else
                    {
                        sprintSelections[i].removeAttribute("selected");
                    }
                }
            }
            else
            {
                for(var i = 0; i < cardTypeSelections.length; i++)
                {
                    if($("#cardTypeShow").val() == cardTypeSelections[i].value)
                    {
                        cardTypeSelections[i].setAttribute("selected", "selected");
                    }
                    else
                    {
                        cardTypeSelections[i].removeAttribute("selected");
                    }
                }

                for(var i = 0; i < templateSelections.length; i++)
                {
                    if($("#templateIdShow").val() == templateSelections[i].value)
                    {
                        templateSelections[i].setAttribute("selected", "selected");
                    }
                    else
                    {
                        templateSelections[i].removeAttribute("selected");
                    }
                }

                for(var i = 0; i < sprintSelections.length; i++)
                {
                    if($("#sprintShow").val() == sprintSelections[i].value)
                    {
                        sprintSelections[i].setAttribute("selected", "selected");
                    }
                    else
                    {
                        sprintSelections[i].removeAttribute("selected");
                    }
                }
            }

            changeRemark = false;

            var pageNo = cardPage.pageNo;
            $("#pageNo").val(pageNo);
            var temp = Math.floor(cardPage.totalCount/cardPage.pageSize) +1;
            $("#maxPage").val(temp);

            if (temp == 1){
                document.getElementById("previous_li").className = "previous disabled";
                document.getElementById("next_li").className = "next disabled";
            }else if (cardPage.pageNo == 1){
                document.getElementById("previous_li").className = "previous disabled";
                document.getElementById("next_li").className = "next";
            }else if (cardPage.pageNo == temp){
                document.getElementById("previous_li").className = "previous";
                document.getElementById("next_li").className = "next disabled";
            }else{
                document.getElementById("previous_li").className = "previous";
                document.getElementById("next_li").className = "next";
            }

            displayData();
            window.history.pushState("","",refreshUrl);
        }).error(function () {
            alert("请求失败，请刷新页面！");
        });
    }

    function request(url,formData){//更新列表
        $.ajax({
            url: url,
            data: formData,
            type: 'POST'
        }).done(function (data) {
            var cardPage = eval("(" + data + ")");
            cardList = cardPage.data;

            for (var i=0;i<cardList.length;i++){
                var sprintId = parseInt(cardList[i].sprint);
                if (sprintId > maxSprintId) {
                    maxSprintId = sprintId;
                }
            }

            if (!sprintListLoaded) {
                for (var i = 0; i <= maxSprintId; i++) {
                    var sprintList = document.getElementById("chooseSprint");

                    var sprintOption = document.createElement("option");
                    sprintOption.value = i;
                    sprintOption.text = i;
                    sprintList.appendChild(sprintOption);
                }

                sprintListLoaded = true;
            }

            var templateId = $('#chooseTemplate option:selected').val();
            var sprintId = $('#chooseSprint option:selected').val();
            var cardType = $('#chooseCardType option:selected').val();

            var cardTypeSelections = document.getElementById("chooseCardType").getElementsByTagName("option");
            for(var i = 0; i < cardTypeSelections.length; i++)
            {
                if(cardType == cardTypeSelections[i].value)
                {
                    cardTypeSelections[i].setAttribute("selected", "selected");
                }
                else
                {
                    cardTypeSelections[i].removeAttribute("selected");
                }
            }

            var pageNo = cardPage.pageNo;
            $("#pageNo").val(pageNo);
            var temp = Math.floor(cardPage.totalCount/cardPage.pageSize) +1;
            $("#maxPage").val(temp);

            if (temp == 1){
                document.getElementById("previous_li").className = "previous disabled";
                document.getElementById("next_li").className = "next disabled";
            }else if (cardPage.pageNo == 1){
                document.getElementById("previous_li").className = "previous disabled";
                document.getElementById("next_li").className = "next";
            }else if (cardPage.pageNo == temp){
                document.getElementById("previous_li").className = "previous";
                document.getElementById("next_li").className = "next disabled";
            }else{
                document.getElementById("previous_li").className = "previous";
                document.getElementById("next_li").className = "next";
            }

            displayData();
        }).error(function () {
            alert("请求失败，请刷新页面！");
        });
    }

    function displayData(){
        sums = ["总计","","","","","","",""];

        if (!doFilter) {
            sortColIdx = -1;

            var cardSorterList = $("#cardHeader").find("a");
            for(var i = 0; i < cardSorterList.length; i++) {
                var sorter = cardSorterList[i];
                var sortername = sorter.getAttribute("name");

                var seperatorIdx = sortername.indexOf("|");
                var realname = sortername.substring(0, seperatorIdx);
                var onclickFun = sortername.substr(seperatorIdx+1);

                sorter.innerHTML = realname;
                sorter.onclick = new Function(onclickFun);
            }

            var headers = document.getElementById("cardHeader");
            var headerOperate = null;
            var childs = headers.children;
            headerOperate = childs[childs.length - 1];
            var k;
            for (k = 8; k < childs.length;) {
                headers.removeChild(childs[k]);
            }

            var filterList = document.getElementById("cardTableFilter");
            var filterChilds = filterList.children;
            for (k = 7; k < filterChilds.length;) {
                filterList.removeChild(filterChilds[k]);
            }
        }

        $('#cardTable').children().remove();
        var cardTable = document.getElementById('cardTable');

        for (var i=0;i<cardList.length;i++){
            var cardId = cardList[i].id;
//                if($('#chooseTemplate option:selected').val() != "-1") {
//                    var url = localhostPaht+'/card/queryCard.htm';
//                    var formData = "cardId="+cardId;
//                    $.ajax({
//                        url: url,
//                        data: formData,
//                        type: 'GET',
//                        async: false
//                    }).done(function (data) {
//                        var card = eval("(" + data + ")");
//                        cardAttrList = card.cardAttrList;
//                        cardAttrLength = cardAttrList.length;
//                    });
//                }
            cardAttrList = cardList[i].cardAttrList;
            cardAttrLength = cardAttrList.length;

            var tr = document.createElement("tr");
            tr.id = "attr_tr_" + cardId;

            var td1 = document.createElement("td");
            td1.innerHTML = cardId;
            tr.appendChild(td1);

            var td2 = document.createElement("td");
            td2.innerHTML = "<a href='"+ localhostPaht + "/card/viewCard.htm?cardId=" + cardList[i].id + "'>" +cardList[i].cardTitle + "</a>";
            td2.setAttribute("name", "title");
            td2.ondblclick = new Function("changeFixedAttr('"+ cardId+"','cardTitle','"+cardList[i].cardTitle+"',event)");
            if (deselectedFixedFilter.indexOf("|title|") >= 0) {
                td2.style.display = "none";
            }
            tr.appendChild(td2);

            var td3 = document.createElement("td");
            td3.innerHTML = cardList[i].lifeStatus;
            td3.setAttribute("name", "status");
            if (deselectedFixedFilter.indexOf("|status|") >= 0) {
                td3.style.display = "none";
            }
            tr.appendChild(td3);

            var tdType = document.createElement("td");
            var cardType = "";
            if(cardList[i].cardType == "1") {
                cardType = "Story";
            } else if(cardList[i].cardType == "2") {
                cardType = "Task";
            } else if(cardList[i].cardType == "3") {
                cardType = "Bug";
            }

            tdType.innerHTML = cardType;
            tdType.setAttribute("name", "cardType");
            if (deselectedFixedFilter.indexOf("|cardType|") >= 0) {
                tdType.style.display = "none";
            }
            tr.appendChild(tdType);

            var tdSprint = document.createElement("td");
            tdSprint.innerHTML = cardList[i].sprint;
            tdSprint.setAttribute("name", "sprint");
            tdSprint.ondblclick = new Function("changeFixedAttr('"+ cardId+"','sprint','"+cardList[i].sprint+"',event)");
            if (deselectedFixedFilter.indexOf("|sprint|") >= 0) {
                tdSprint.style.display = "none";
            }
            tr.appendChild(tdSprint);

            var sprintId = parseInt(cardList[i].sprint);
            if (sprintId > maxSprintId) {
                maxSprintId = sprintId;
            }

//            var td4 = document.createElement("td");
//            var templateId = cardList[i].templateId;
//            td4.innerHTML = document.getElementById("template-"+templateId).innerHTML;
//            td4.setAttribute("name", "template");
//            if (deselectedFixedFilter.indexOf("|template|") >= 0) {
//                td4.style.display = "none";
//            }
//            tr.appendChild(td4);
//
//            var td5 = document.createElement("td");
//            if (undefined != cardList[i].creator && "" !=cardList[i].creator){
//                td5.innerHTML = cardList[i].creator;
//            }
//            td5.setAttribute("name", "creator");
//            if (deselectedFixedFilter.indexOf("|creator|") >= 0) {
//                td5.style.display = "none";
//            }
//            tr.appendChild(td5);

            var td6 = document.createElement("td");
            if (undefined != cardList[i].createTime && "" != cardList[i].createTime){
                var createDate = new Date(cardList[i].createTime);
                td6.innerHTML = createDate.getFullYear()+"/"+ leftPad((createDate.getMonth()+1).toString(),2,"0")+"/"+leftPad(createDate.getDate().toString(),2,"0");
            }
            td6.setAttribute("name", "createTime");
            if (deselectedFixedFilter.indexOf("|createTime|") >= 0) {
                td6.style.display = "none";
            }
            tr.appendChild(td6);

            if($('#chooseTemplate option:selected').val() != -1) {
                var j;

                if (typeof(tempParentAttrList) != "undefined") {
                    var ignoredLength = 0;
                    for (j = 0; j < tempParentAttrList.length; j++) {
                        var tdAttr = document.createElement("td");
                        for(var p = 0; p < tempParentAttrList.length; p++) {
                            if (tempParentAttrList[p].inputType == "execute") {
                                optionAttrName = tempParentAttrList[p].inputOption;
                                optionName = tempParentAttrList[p].attrLabel;
                                optionArray = optionName.split(":");
                            }
                        }



                        if (tempParentAttrList[j].inputType != "richText") {
                            var attrValue = "";

                            for (var k = 0; k < cardAttrLength; k++) {
                                if (cardAttrList[k].attrName == tempParentAttrList[j].attrLabel) {
                                    attrValue = cardAttrList[k].attrValue;
                                    if (cardAttrList[k].attrName == optionArray[0]) {
                                        optionValue1 = attrValue;
                                        if(optionValue1 == "")
                                            optionValue1 = "0";
                                    }
                                    if(cardAttrList[k].attrName == optionArray[2]) {
                                        optionValue2 = attrValue;
                                        if(optionValue2 == "")
                                            optionValue2 = "0";
                                    }
                                    break;
                                }
                            }

                            if (tempParentAttrList[j].inputType == "number" && tempParentAttrList[j].attrLabel != "优先级") {
                                var tempValue = 0;
                                if (attrValue != "") {
                                    tempValue  = attrValue;
                                }

                                if (sums.length <= 8 + j) {
                                    sums.push(tempValue);
                                } else {
                                    sums[8 + j - ignoredLength] = (parseFloat(tempValue) + parseFloat(sums[8 + j - ignoredLength])).toString();
                                }
                            } else {
                                if (sums.length <= 8 + j - ignoredLength) {
                                    sums.push("");
                                }
                            }
                            if (tempParentAttrList[j].inputType == "execute"){
                                tdAttr.id = "execute-id";
                                optionAttrName = tempParentAttrList[j].inputOption;
                                if(optionArray[1] == "加") {
                                    attrValue  = parseFloat(optionValue1) + parseFloat(optionValue2);
                                    optionValue1 = "0";
                                    optionValue2 = "0";
                                }
                                else if(optionArray[1] == "减"){
                                    attrValue  = parseFloat(optionValue1) - parseFloat(optionValue2);
                                    optionValue1 = "0";
                                    optionValue2 = "0";
                                }
                                if(isNaN(attrValue)){
                                    attrValue  = "";
                                }

                            }


                            tdAttr.innerHTML = attrValue;
                            tdAttr.setAttribute("name", tempParentAttrList[j].attrLabel);

                            if(tempParentAttrList[j].inputType == "singleText" || tempParentAttrList[j].inputType == "number" ||tempParentAttrList[j].inputType == "execute") {
                                tdAttr.ondblclick = new Function("changeCustomizedAttr('" + cardId + "','" + tempParentAttrList[j].id + "','" + attrValue + "','" + tempParentAttrList[j].inputType + "'," + (8 + j - ignoredLength)  + ",event)");
                            }

                            if (doFilter && deselectedCustomizedFilter.indexOf("|" + tempParentAttrList[j].attrLabel + "|") >= 0) {
                                tdAttr.style.display = "none";
                            }
                            tr.appendChild(tdAttr);

                            if (i == 0 && !doFilter) {
                                var headerAttr = document.createElement("th");
                                if (tempParentAttrList[j].inputType == "number") {
                                    var headerHtml = "<a name=\"" + tempParentAttrList[j].attrLabel + "|sortTable(" + (8 + j - ignoredLength) + ", '" + tempParentAttrList[j].attrLabel + "', 'number', true, event)\" " +
                                            "herf='#' onclick=\"sortTable(" + (8 + j - ignoredLength) + ", '" + tempParentAttrList[j].attrLabel + "', 'number', true, event)\">" + tempParentAttrList[j].attrLabel + "<" + "/a>";

                                    headerAttr.innerHTML = headerHtml;
                                } else if (tempParentAttrList[j].inputType == "singleText") {
                                    var headerHtml = "<a name=\"" + tempParentAttrList[j].attrLabel + "|sortTable(" + (8 + j - ignoredLength) + ", '" + tempParentAttrList[j].attrLabel + "', 'text', true, event)\" " +
                                            "herf='#' onclick=\"sortTable(" + (8 + j - ignoredLength) + ", '" + tempParentAttrList[j].attrLabel + "', 'text', true, event)\">" + tempParentAttrList[j].attrLabel + "<" + "/a>";

                                    headerAttr.innerHTML = headerHtml;
                                }
                                else if (tempParentAttrList[j].inputType == "execute"){
                                    var headerHtml = "<a name=\"" + tempParentAttrList[j].attrLabel + "|sortTable(" + (8 + j - ignoredLength) + ", '" + tempParentAttrList[j].attrLabel + "', 'number', true, event)\" " +
                                            "herf='#' onclick=\"sortTable(" + (8 + j - ignoredLength) + ", '" + tempParentAttrList[j].attrLabel + "', 'number', true, event)\">" + tempParentAttrList[j].attrLabel + "<" + "/a>";

                                    headerAttr.innerHTML = headerHtml;

                                }
                                else {
                                    headerAttr.innerHTML = tempParentAttrList[j].attrLabel;
                                }
                                headerAttr.setAttribute("name", tempParentAttrList[j].attrLabel);
                                headers.appendChild(headerAttr);

                                var filterAttr = document.createElement("option");
                                filterAttr.value = tempParentAttrList[j].attrLabel;
                                filterAttr.selected = "selected";
                                filterAttr.text = tempParentAttrList[j].attrLabel;
                                filterList.appendChild(filterAttr);
                            }
                        } else {
                            ignoredLength++;
                        }
                    }
                }

                if (typeof(tempAttrList) != "undefined") {
                    var ignoredLength = 0;
                    for (j = 0; j < tempAttrList.length; j++) {
                        var tdAttr = document.createElement("td");

                        for(var p = 0; p < tempAttrList.length; p++) {
                            if (tempAttrList[p].inputType == "execute") {
                                optionAttrName = tempAttrList[p].inputOption;
                                optionName = tempAttrList[p].attrLabel;
                                optionArray = optionName.split(":");
                            }
                        }

                        if (tempAttrList[j].inputType != "richText") {
                            var attrValue = "";

                            for (var k = 0; k < cardAttrLength; k++) {
                                if (cardAttrList[k].attrName == tempAttrList[j].attrLabel) {
                                    attrValue = cardAttrList[k].attrValue;
                                    if (cardAttrList[k].attrName == optionArray[0]) {
                                        optionValue1 = attrValue;
                                        if(optionValue1 == "")
                                            optionValue1 = "0";
                                    }
                                    if(cardAttrList[k].attrName == optionArray[2]) {
                                        optionValue2 = attrValue;
                                        if(optionValue2 == "")
                                            optionValue2 = "0";
                                    }
                                    break;
                                }
                            }

                            if (tempAttrList[j].inputType == "number" && tempAttrList[j].attrLabel != "优先级") {
                                var tempValue = 0;
                                if (attrValue != "") {
                                    tempValue  = attrValue;
                                }

                                if (sums.length <= 8 + tempParentAttrLength + j - ignoredLength) {
                                    sums.push(tempValue);
                                } else {
                                    sums[8 + tempParentAttrLength + j - ignoredLength] =
                                            (parseFloat(tempValue) + parseFloat(sums[8 + tempParentAttrLength + j - ignoredLength])).toString();
                                }
                            } else {
                                if (sums.length <= 8 + tempParentAttrLength + j - ignoredLength) {
                                    sums.push("");
                                }
                            }

                            if (tempAttrList[j].inputType == "execute"){

                                tdAttr.id = "execute-id";
                                optionAttrName = tempAttrList[j].inputOption;
                                if(optionArray[1] == "加") {
                                    attrValue = parseFloat(optionValue1) +parseFloat(optionValue2);
                                    optionValue1 = "0";
                                    optionValue2 = "0";
                                }
                                else if(optionArray[1] == "减"){
                                    attrValue =parseFloat(optionValue1) - parseFloat(optionValue2);
                                    optionValue1 = "0";
                                    optionValue2 = "0";
                                }
                                if(isNaN(attrValue))
                                    attrValue = "";
                            }

                            tdAttr.innerHTML = attrValue;
                            tdAttr.setAttribute("name", tempAttrList[j].attrLabel);

                            if(tempAttrList[j].inputType == "singleText" || tempAttrList[j].inputType == "number" ||tempAttrList[j].inputType == "execute") {
                                tdAttr.ondblclick = new Function("changeCustomizedAttr('" + cardId + "','" + tempAttrList[j].id + "','" + attrValue + "','" + tempAttrList[j].inputType + "'," + (8 + tempParentAttrLength + j - ignoredLength)  +",event)");
                            }

                            if (doFilter && deselectedCustomizedFilter.indexOf("|" + tempAttrList[j].attrLabel + "|") >= 0) {
                                tdAttr.style.display = "none";
                            }
                            tr.appendChild(tdAttr);

                            if (i == 0 && !doFilter) {
                                var headerAttr = document.createElement("th");
                                if (tempAttrList[j].inputType == "number") {
                                    var headerHtml = "<a name=\"" + tempAttrList[j].attrLabel + "|sortTable(" + (8 + tempParentAttrLength + j - ignoredLength) + ", '" + tempAttrList[j].attrLabel + "', 'number', true, event)\" " +
                                            "herf='#' onclick=\"sortTable(" + (8 + tempParentAttrLength + j - ignoredLength) + ", '" + tempAttrList[j].attrLabel + "', 'number', true, event)\">" + tempAttrList[j].attrLabel + "<" + "/a>";

                                    headerAttr.innerHTML = headerHtml;
                                } else if (tempAttrList[j].inputType == "singleText") {
                                    var headerHtml = "<a name=\"" + tempAttrList[j].attrLabel + "|sortTable(" + (8 + tempParentAttrLength + j - ignoredLength) + ", '" + tempAttrList[j].attrLabel + "', 'text', true, event)\" " +
                                            "herf='#' onclick=\"sortTable(" + (8 + tempParentAttrLength + j - ignoredLength) + ", '" + tempAttrList[j].attrLabel + "', 'text', true, event)\">" + tempAttrList[j].attrLabel + "<" + "/a>";

                                    headerAttr.innerHTML = headerHtml;
                                }
                                else if (tempAttrList[j].inputType == "execute"){
//                                    optionAttrName = tempAttrList[j].inputOption;
//                                    headerAttr.innerHTML = tempAttrList[j].attrLabel;
//                                    optionName = tempAttrList[j].attrLabel;
//                                    optionArray = optionName.split(":");
                                    var headerHtml = "<a name=\"" + tempAttrList[j].attrLabel + "|sortTable(" + (8 + tempParentAttrLength + j - ignoredLength) + ", '" + tempAttrList[j].attrLabel + "', 'number', true, event)\" " +
                                            "herf='#' onclick=\"sortTable(" + (8 + tempParentAttrLength + j - ignoredLength) + ", '" + tempAttrList[j].attrLabel + "', 'number', true, event)\">" + tempAttrList[j].attrLabel + "<" + "/a>";

                                    headerAttr.innerHTML = headerHtml;
                                }
//
                                else {
                                    headerAttr.innerHTML = tempAttrList[j].attrLabel;

                                }
                                headerAttr.setAttribute("name", tempAttrList[j].attrLabel);
                                headers.appendChild(headerAttr);

                                var filterAttr = document.createElement("option");
                                filterAttr.value = tempAttrList[j].attrLabel;
                                filterAttr.selected = "selected";
                                filterAttr.text = tempAttrList[j].attrLabel;
                                filterList.appendChild(filterAttr);
                            }
                        } else {
                            ignoredLength++;
                        }
                    }
                }
            }

            if (!doFilter) {
                $('#cardTableFilter').multiselect('rebuild');
            }

            var td9 = document.createElement("td");

            var view = document.createElement("a");
            //view.setAttribute("onclick","viewCard("+cardList[i].id+")");
            view.innerHTML = "复制";
            view.href = localhostPaht+"/card/copyCard.htm?cardId="+cardList[i].id;
            view.target = "_blank";
            td9.appendChild(view);

            var seperator = document.createElement("font");
            seperator.innerHTML = "|";
            td9.appendChild(seperator);

            var editor = document.createElement("a");
            editor.href = localhostPaht+"/card/editAttr.htm?cardId="+cardList[i].id;
            editor.innerHTML = "编辑";
            editor.target = "_blank";
            td9.appendChild(editor);

            var seperator2 = document.createElement("font");
            seperator2.innerHTML = "|";
            td9.appendChild(seperator2);

            var dele = document.createElement("a");
            dele.setAttribute("name","delete");
            dele.setAttribute("onclick","deleCard("+cardList[i].id+")");
            dele.innerHTML = "删除";
            td9.appendChild(dele);

            tr.appendChild(td9);

            cardTable.appendChild(tr);

        }

        var tr = document.createElement("tr");
        tr.id = "sum-id";

        var td1 = document.createElement("td");
        td1.innerHTML = sums[0];
        tr.appendChild(td1);

        var td2 = document.createElement("td");
        td2.innerHTML = sums[1];
        td2.setAttribute("name", "title");
        if (deselectedFixedFilter.indexOf("|title|") >= 0) {
            td2.style.display = "none";
        }
        tr.appendChild(td2);

        var td3 = document.createElement("td");
        td3.innerHTML = sums[2];
        td3.setAttribute("name", "status");
        if (deselectedFixedFilter.indexOf("|status|") >= 0) {
            td3.style.display = "none";
        }
        tr.appendChild(td3);

        var tdType = document.createElement("td");
        tdType.innerHTML = sums[3];
        tdType.setAttribute("name", "cardType");
        if (deselectedFixedFilter.indexOf("|cardType|") >= 0) {
            tdType.style.display = "none";
        }
        tr.appendChild(tdType);

        var tdSprint = document.createElement("td");
        tdSprint.innerHTML = sums[4];
        tdSprint.setAttribute("name", "sprint");
        if (deselectedFixedFilter.indexOf("|sprint|") >= 0) {
            tdSprint.style.display = "none";
        }
        tr.appendChild(tdSprint);

//        var td4 = document.createElement("td");
//        td4.innerHTML = sums[5];
//        td4.setAttribute("name", "template");
//        if (deselectedFixedFilter.indexOf("|template|") >= 0) {
//            td4.style.display = "none";
//        }
//        tr.appendChild(td4);
//
//        var td5 = document.createElement("td");
//        td5.innerHTML = sums[6];
//        td5.setAttribute("name", "creator");
//        if (deselectedFixedFilter.indexOf("|creator|") >= 0) {
//            td5.style.display = "none";
//        }
//        tr.appendChild(td5);

        var td6 = document.createElement("td");
        td6.innerHTML = sums[7];
        td6.setAttribute("name", "createTime");
        if (deselectedFixedFilter.indexOf("|createTime|") >= 0) {
            td6.style.display = "none";
        }
        tr.appendChild(td6);

        var k;
        for (k = 8; k < 8 + tempParentAttrLength; k++) {
            var tdSum = document.createElement("td");
            tdSum.innerHTML = sums[k];
            tdSum.setAttribute("name", tempParentAttrList[k - 8].attrLabel);
            if (deselectedFixedFilter.indexOf("|" + tempParentAttrList[k - 8].attrLabel + "|") >= 0) {
                tdSum.style.display = "none";
            }
            tr.appendChild(tdSum);
        }

        for (k = 8 + tempParentAttrLength; k < 8 + tempParentAttrLength + tempAttrLength; k++) {
            var tdSum = document.createElement("td");
            tdSum.innerHTML = sums[k];
            tdSum.setAttribute("name", tempAttrList[k - 8 - tempParentAttrLength].attrLabel);
            if (deselectedFixedFilter.indexOf("|" + tempAttrList[k - 8 - tempParentAttrLength].attrLabel + "|") >= 0) {
                tdSum.style.display = "none";
            }
            tr.appendChild(tdSum);
        }

        var td9 = document.createElement("td");
        tr.appendChild(td9);

        cardTable.appendChild(tr);

        if (!doFilter) {
            headers.appendChild(headerOperate);
        }

//        if (!sprintListLoaded) {
//            for (var i = 0; i <= maxSprintId; i++) {
//                var sprintList = document.getElementById("chooseSprint");
//
//                var sprintOption = document.createElement("option");
//                sprintOption.value = i;
//                sprintOption.text = i;
//
////                if (sprintId != -1 && sprintId == i) {
////                    sprintOption.setAttribute("selected", "selected");
////                }
//
//                sprintList.appendChild(sprintOption);
//            }
//
//            sprintListLoaded = true;
//        }

        if (sortColIdx != -1 && doFilter) {
            sortTable(sortColIdx, sortName, sortType, sortSeq, sortEvent);
        }
    }


    function isFixedAttr(attrName) {
        return fixedAttr.indexOf(attrName) >= 0;
    }

    function showLane() {
        window.open("/card/showLane.htm?spaceId="+$("#spaceId").val()+"&maxSprintId="+maxSprintId);
    }

    function changeFixedAttr(cardId, attrName, attrValue, event) {
        var e = event || window.event;
        var classTemp = "";

        if(attrName=="sprint") {
            classTemp = "class='numberTemplate' style='width:20px;'";
        } else {
            classTemp = "style='width:95%;'";
        }

        e.srcElement.innerHTML = "<input id='attrEdit' type='text' name='"+attrName+"' "+classTemp+" value='"+attrValue
        +"' onkeydown='submitFixedAttr(\""+cardId+"\",\""+attrName+"\",event)'" +
        " onBlur='submitFixedAttr(\""+cardId+"\",\""+attrName+"\",event)'>";

        clearSlct();
        document.getElementById("attrEdit").setSelectionRange(attrValue.length, attrValue.length);
        document.getElementById("attrEdit").focus();
    }

    function submitFixedAttr(cardId, attrName, event) {
        var e = event || window.event;

        if(e && (e.keyCode == 13 || e.type == "blur")) {
            if(e.keyCode == 13) {
                e.srcElement.onblur = null;
            }

            var url = localhostPaht+'/card/modifyCardBasic.htm';
            var formData = "cardId="+cardId+"&"+attrName+"="+ e.srcElement.value;

            $.ajax({
                url: url,
                data: formData,
                type: 'POST'
            }).done(function (data) {

            }).error(function () {
                alert("请求失败，请刷新页面！");
            });

            if (attrName == "sprint") {
                filteredRequest();
            }

            var newValue = e.srcElement.value;
            e.srcElement.parentNode.ondblclick = new Function("changeFixedAttr('"+ cardId+"','"+attrName+"','"+ e.srcElement.value+"',event)");
            e.srcElement.parentNode.innerHTML = "<a href='"+ localhostPaht + "/card/viewCard.htm?cardId=" + cardId + "'>" +newValue + "</a>";

            if (sortColIdx != -1) {
                sortTable(sortColIdx, sortName, sortType, sortSeq, sortEvent);
            }

            updateCache("fixed", cardId, attrName, newValue);
        }
    }

    function changeCustomizedAttr(cardId, attrId, attrValue, attrType, colIdx, event) {
        var e = event || window.event;
        var classTemp = "";

        if(attrType=="number") {
            classTemp = "class='numberTemplate' style='width:35px;'";
        } else {
            classTemp = "style='width:70px;'";
        }

        e.srcElement.innerHTML = "<input id='attrEdit' type='text' name='attrValue' "+classTemp+" value='"+attrValue
        +"' onkeydown='submitCustomizedAttr(\""+cardId+"\",\""+attrId+"\",\""+attrValue+"\",\""+attrType+"\","+colIdx+ ",event)'" +
        " onBlur='submitCustomizedAttr(\""+cardId+"\",\""+attrId+"\",\""+attrValue+"\",\""+attrType+"\","+colIdx +",event)'>";

        clearSlct();
        document.getElementById("attrEdit").setSelectionRange(attrValue.length, attrValue.length);
        document.getElementById("attrEdit").focus();
    }

    function submitCustomizedAttr(cardId, attrId, attrValue, attrType, colIdx, event) {//attrType，colIdx和event没有传送
        var e = event || window.event;

        if(e && (e.keyCode == 13 || e.type == "blur")) {
            if(e.keyCode == 13) {
                e.srcElement.onblur = null;
            }

            var url = localhostPaht + '/card/modifyCardSingleAttr.htm';
            var formData = "spaceId=" + $("#spaceId").val() + "&templateId="
                    + $('#chooseTemplate option:selected').val() + "&cardId="
                    + cardId + "&attrId=" + attrId + "&attrValue=" + e.srcElement.value;

            $.ajax({
                url: url,
                data: formData,
                type: 'POST'
            }).done(function (data) {

            }).error(function () {
                alert("请求失败，请刷新页面！");
            });

            var oldValue = attrValue;
            if(oldValue == "") {
                oldValue = 0;
            }

            var newValue = e.srcElement.value;
            if(newValue == "") {
                newValue = 0;
            }

            e.srcElement.parentNode.ondblclick = new Function("changeCustomizedAttr('" + cardId + "','" + attrId + "','" + e.srcElement.value + "','" + attrType + "'," + colIdx + ",event)");//重新设置双击事件
            console.info(e.srcElement.parentNode.innerHTML);
            e.srcElement.parentNode.innerHTML = e.srcElement.value;//此处的e.srcElement为新建的一个input控件

            if (attrType == "number") {
                optionAttrId = optionAttrName.split(":");
                if (attrId == parseInt(optionAttrId[1])) {
                    var rows = document.getElementById("cardTable").getElementsByTagName("tr");
                    for (i = 0; i < rows.length; i++) {
                        if (rows[i].getAttribute("id") == ("attr_tr_" + cardId)) {
                            var cols = rows[i].getElementsByTagName("td");
                            for (j = 0; j < cols.length; j++) {
                                if (cols[j].getAttribute("id") == "execute-id") {
                                    var diffValue1 = parseFloat(newValue) - parseFloat(oldValue);
                                    var oldStatisticValue1 = parseFloat(cols[j].innerHTML);
                                    cols[j].innerHTML = oldStatisticValue1 + diffValue1;
                                    if(cols[j].innerHTML == "NaN"){
                                        cols[j].innerHTML = newValue;
                                    }
                                    break;
                                }
                            }
                        }
                    }
                }
                if (attrId == parseInt(optionAttrId[2])) {
                    var rows = document.getElementById("cardTable").getElementsByTagName("tr");
                    for (i = 0; i < rows.length; i++) {
                        if (rows[i].getAttribute("id") == ("attr_tr_" + cardId)) {
                            var cols = rows[i].getElementsByTagName("td");
                            for (j = 0; j < cols.length; j++) {
                                if (cols[j].getAttribute("id") == "execute-id") {
                                    var diffValue1 = parseFloat(newValue) - parseFloat(oldValue);
                                    var oldStatisticValue1 = parseFloat(cols[j].innerHTML);
                                    if(optionAttrId[0] == "0") {
                                        cols[j].innerHTML = oldStatisticValue1 + diffValue1;
                                        if(cols[j].innerHTML == "NaN"){
                                            cols[j].innerHTML = newValue;
                                        }
                                    }
                                    if(optionAttrId[0] == "1") {
                                        cols[j].innerHTML = oldStatisticValue1 - diffValue1;
                                        if(cols[j].innerHTML == "NaN"){
                                            cols[j].innerHTML = -newValue;
                                        }
                                    }
                                    break;
                                }
                            }
                        }
                    }
                }
                var diffValue = parseFloat(newValue) - parseFloat(oldValue);
                var oldStatisticValue = parseFloat($("#sum-id").find("td").eq(colIdx)[0].innerHTML);

                $("#sum-id").find("td").eq(colIdx)[0].innerHTML = oldStatisticValue + diffValue;
            }

            if (sortColIdx != -1) {
                sortTable(sortColIdx, sortName, sortType, sortSeq, sortEvent);
            }

            updateCache("customized", cardId, attrId, newValue);
        }
    }

    var clearSlct= "getSelection" in window ? function(){
        window.getSelection().removeAllRanges();
    } : function(){
        document.selection.empty();
    };

    function swapRow(i, k)
    {
        var cardTable = $("#cardTable").find("tr");
        $(cardTable).eq(k).insertBefore($(cardTable).eq(i));
        $(cardTable).eq(i).insertAfter($(cardTable).eq(k));
    }

    function sortTable(col, name, type, asc, event)
    {
        sortColIdx = col;
        sortName = name;
        sortType = type;
        sortSeq = asc;
        sortEvent = event;

        var cardSorterList = $("#cardHeader").find("a");
        for(var i = 0; i < cardSorterList.length; i++) {
            var sorter = cardSorterList[i];
            var sortername = sorter.getAttribute("name");

            var seperatorIdx = sortername.indexOf("|");
            var realname = sortername.substring(0, seperatorIdx);
            var onclickFun = sortername.substr(seperatorIdx+1);

            sorter.innerHTML = realname;
            sorter.onclick = new Function(onclickFun);
        }

        var cardTable = $("#cardTable").find("tr");
        var total = cardTable.length;

        for (var i = 0; i < total - 1; i++)
        {
            //内层循环，找到第i大的元素，并将其和第i个元素交换
            for (var j = i; j < total - 1; j++)
            {
                var value1 = $(cardTable).eq(i).find("td").eq(col).text();
                var value2 = $(cardTable).eq(j).find("td").eq(col).text();

                if (type == "number") {
                    var v1 = asc ? 9999 : 0;
                    if (value1 != "") {
                        v1 = parseFloat(value1);
                    }

                    var v2 = asc ? 9999 : 0;
                    if (value2 != "") {
                        v2 = parseFloat(value2);
                    }
                    if ((asc && v1 > v2) || (!asc && v1 < v2)) {
                        //交换两个元素的位置
                        swapRow(i, j);
                        cardTable = $("#cardTable").find("tr");
                    }
                } else if (type == "text") {
                    var compareResult = 0;

                    if (value1 == "" && value2 == "") {
                        continue;
                    } else if (value1 == "" && value2 != "") {
                        compareResult = asc ? 1 : -1;
                    } else if (value1 != "" && value2 == "") {
                        compareResult = asc ? -1 : 1;
                    } else {
                        compareResult = value1.localeCompare(value2);
                    }

                    if ((asc && compareResult > 0) || (!asc && compareResult < 0 )) {
                        //交换两个元素的位置
                        swapRow(i, j);
                        cardTable = $("#cardTable").find("tr");
                    }
                }
            }
        }

        var e = event || window.event;
        if (asc) {
            e.srcElement.innerHTML = name+"&uarr;"
            e.srcElement.onclick = new Function("sortTable(" + col + ",'"+name+"','" + type + "',false,event)");
        } else {
            e.srcElement.innerHTML = name+"&darr;"
            e.srcElement.onclick = new Function("clearSort("+col+",'"+name+"','" + type + "',event)");
        }
    }

    function clearSort(col, name, type, event) {
        sortColIdx = -1;

        var e = event || window.event;
        e.srcElement.innerHTML = name;
        e.srcElement.onclick = new Function("sortTable(" + col + ",'"+name+"','" + type + "',true,event)");

        displayData();
    }

    function updateCache(attrType, cardId, attrNameID, newValue) {
        if (attrType == "fixed") {
            if (attrNameID == "cardTitle") {
                for (var i = 0; i < cardList.length; i++) {
                    if (cardList[i].id == cardId) {
                        cardList[i].cardTitle = newValue;
                        break;
                    }
                }
            } else if (attrNameID == "sprint") {
                for (var i = 0; i < cardList.length; i++) {
                    if (cardList[i].id == cardId) {
                        cardList[i].sprint = newValue;
                        break;
                    }
                }
            }
        } else if (attrType == "customized") {
            for (var i = 0; i < cardList.length; i++) {
                if (cardList[i].id == cardId) {
                    var cardAttrList = cardList[i].cardAttrList;
                    for (var j = 0; j < cardAttrList.length; j++) {
                        if (attrNameID == cardAttrList[j].attrId) {
                            cardAttrList[j].attrValue = newValue;
                            break;
                        }
                    }
                    break;
                }
            }
        }
    }

    $(document).ready(function() {
        $("#exportExcel").click(function () {
            var templateId = $('#chooseTemplate option:selected').val();
            var sprintId = $('#chooseSprint option:selected').val();
            var cardType = $('#chooseCardType option:selected').val();
            var formData = "?spaceId="+$("#spaceId").val()+"&templateId="+templateId+"&sprintId="+sprintId+"&cardType="+cardType;
            $("#exportExcel").attr("href", "/card/export" + formData);
        });
    });
</script>
